<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>MexIFace: MexIFace BLAS and LAPACK 64-bit Integer Setup</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MexIFace
   </div>
   <div id="projectbrief">A C++/Matlab object-based interface library and cross-platform CMake MEX build tool.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">MexIFace BLAS and LAPACK 64-bit Integer Setup </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Matlab includes internal BLAS and LAPACK libraries (<code>libmwblas</code>, <code>libmwlapack</code>, and the <a href="https://software.intel.com/en-us/mkl">intel MKL</a>) that are compiled with 64-bit integer indexing, making them incompatible with the more common 32-bit integer indexed BLAS and LAPACK libraries.</p>
<p>Technically, it is possible to build a library that links directly to Matlab's internal <code>libmwblas</code> and <code>libmwlapack</code> libraries without a system-provided 64-bit BLAS or LAPACK, however such a library would not be usable outside of Matlab by other C++ applications or executables, including those necessary to test the library.</p>
<p>Building a dual-use C++ library that will link against Matlab MEX modules requires a development environment with 64-bit integer ABI versions of BLAS and LAPACK libraries.</p>
<h1>BLAS and LAPACK CMake Find Modules</h1>
<p>The MexIFace CMake build system uses customized BLAS and LAPACK find modules from the <a href="https://github.com/markjolah/UncommonCMakeModules">UncommonCMakeModules</a> package.</p><ul>
<li><a href="https://github.com/markjolah/UncommonCMakeModules/blob/master/FindArmadillo.cmake"><code>FindArmadillo.cmake</code></a></li>
<li><a href="https://github.com/markjolah/UncommonCMakeModules/blob/master/FindBLAS.cmake"><code>FindBLAS.cmake</code></a></li>
<li><a href="https://github.com/markjolah/UncommonCMakeModules/blob/master/FindLAPACK.cmake"><code>FindLAPACK.cmake</code></a><ul>
<li><a href="https://github.com/markjolah/UncommonCMakeModules/blob/master/MakePkgConfigTarget.cmake"><code>MakePkgConfigTarget.cmake</code></a></li>
</ul>
</li>
</ul>
<p>These modules accept a <code>BLAS_INT64</code> COMPONENT argument to <a href="https://cmake.org/cmake/help/latest/command/find_package.html"><code>find_package()</code></a>, which enables detection of both 32-bit and 64-bit CMake imported interface targets:</p><ul>
<li>32-bit Integer ABI targets<ul>
<li><code>Blas::Blas</code></li>
<li><code>Lapack::Lapack</code></li>
</ul>
</li>
<li>64-bit Integer ABI targets<ul>
<li><code>Blas::BlasInt64</code></li>
<li><code>Lapack::LapackInt64</code></li>
</ul>
</li>
</ul>
<p>By using an <code>OPT_BLAS_INT64</code> CMake option to switch between these different target names, it is possible to easily build either 32-bit and 64-bit integer ABI versions of a C++ library. Any Matlab modules must link against the 64-bit ABI version. The <a href="https://github.com/markjolah/MexIFace-Example">MexIFace-Example</a> project demonstrates this approach.</p>
<h2>pkg-config files</h2>
<p>The <code>FindBLAS.cmake</code> and <code>FindLAPACK.cmake</code> modules use <a href="https://people.freedesktop.org/~dbn/pkg-config-guide.html"><code>pkg-config</code></a> files to locate the 32-bit and 64-bit versions of BLAS, CBLAS, and LAPACK.</p>
<ul>
<li>32-bit Integer ABI targets<ul>
<li><code>blas.pc</code> or <code>openblas.pc</code></li>
<li><code>lapack.pc</code></li>
</ul>
</li>
<li>64-bit Integer ABI targets<ul>
<li><code>blas-int64.pc</code> or <code>openblas-int64.pc</code></li>
<li><code>lapack-int64.pc</code></li>
</ul>
</li>
</ul>
<p>Normally these files are at <code>/usr/lib/pkgconfig</code>, but they can be anywhere on <code>PKG_CONFIG_PATH</code>. If your system does not provide 64-bit versions use one of the <a href="#example-pkg-config-setups">example pkg-config setups</a>.</p>
<h1>Installing BLAS and LAPACK with 64-bit integer support</h1>
<h2>Gentoo</h2>
<p>The <a href="https://github.com/gentoo/sci">Gentoo science overlay</a> provides the ability to simultaneously install multiple BLAS and LAPACK packages and variants on those packages using different integer size and threading options. Each variant will have distinct shared and static library names and corresponding <code>pkg-config</code> files which describe how to link against them.</p>
<ol type="1">
<li>Use <a href="https://wiki.gentoo.org/wiki/Layman">layman</a> to add the science overlay, <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;layman -a science</div></div><!-- fragment --></li>
<li>Follow the <a href="https://github.com/gentoo/sci#blas-and-lapack-migration">science overlay README</a> migration directions. This is necessary to update the <code>eselect</code> configuration tool to be aware of the different BLAS and LAPACK variants.</li>
<li>Modify<code>/etc/portage/package.use</code> to enable the <code>int64</code> use flag for relevent BLAS and LAPACK packages which builds 64-bit integer ABI versions alongside the normal 32-bit versions. <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;sci-libs/blas-reference int64</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;sci-libs/lapack-reference int64</div></div><!-- fragment --></li>
<li>Emerge or re-emerge the reference packages <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;emerge blas-reference  lapack-reference</div></div><!-- fragment --></li>
<li>Use <code>eselect</code> to check the status of the system default packages. <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;eselect blas list</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;eselect blas-int64 list</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;eselect lapack list</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;eselect lapack-int64 list</div></div><!-- fragment --></li>
</ol>
<p>This basic setup is sufficient for simple projects. For BLAS and LAPACK critical workloads however, other implementations with superior performance exist.</p><ul>
<li><code>sci-libs/gotoblas2</code> [BLAS] (Available USE flags: <code>int64</code>, <code>openmp</code>, <code>threads</code>)</li>
<li><code>sci-libs/openblas</code> [BLAS] (Available USE flags: <code>int64</code>, <code>openmp</code>, <code>threads</code>)</li>
<li><code>sci-libs/gsl</code> [CBLAS]</li>
<li><code>sci-libs/mkl</code> [BLAS/CBLAS/LAPACK] (Available USE flags: <code>int64</code>)</li>
</ul>
<p>Notes:</p><ul>
<li>After using <code>eselect</code> to change <code>blas</code> or <code>blas-int64</code>, LAPACK libraries will require rebuilding for the change in BLAS dependencies to become transitive.</li>
</ul>
<h2>Debian/Ubuntu</h2>
<p>Debian and Ubuntu variants only have 32-bit integer BLAS and LAPACK packages available as the packages <a href="https://packages.ubuntu.com/search?suite=all&amp;keywords=libblas-dev"><code>libblas-dev</code></a> and <a href="https://packages.ubuntu.com/search?suite=all&amp;keywords=liblapack-dev"><code>liblapack-dev</code></a>.</p>
<ul>
<li><a href="https://wiki.debian.org/DebianScience/LinearAlgebraLibraries">DebianScience Lapack/Blas libraries</a> has 64-bit MKL packages links but these are <em>non-free</em>.</li>
</ul>
<h2>Building manually</h2>
<p>Building the reference BLAS and LAPACK with 64-bit integer support is not difficult if there is no easier way to get the libraries for your distribution:</p><ol type="1">
<li>Use the latest <a href="https://github.com/Reference-LAPACK/lapack-release">lapack-release</a> from github</li>
<li>Set the gfortran <code>-fdefault-int-8</code> to force 64-bit integer support.</li>
<li>create proper pkg-config files at <code>/usr/lib/pkgconfig/blas-int64.pc</code> and <code>/usr/lib/pkgconfig/lpack-int64.pc</code>.</li>
</ol>
<p>Example Ubuntu/TravisCI scripts are available in the <a href="https://github.com/markjolah/ci-numerical-dependencies">ci-numerical-dependencies</a> git subrepo.</p><ul>
<li><a href="https://github.com/markjolah/ci-numerical-dependencies/blob/master/install-blas-lapack.sh">install-blas-lapack.sh</a> - Set environment variable <code>BLAS_INT64=1</code></li>
<li><a href="https://github.com/markjolah/ci-numerical-dependencies/blob/master/install-armadillo.sh">install-armadillo.sh</a> - Installs more recent <a href="https://gitlab.com/conradsnicta/armadillo-code">armadillo</a> for optimal use of BLAS/LAPACK operations.</li>
</ul>
<p><a class="anchor" id="example-pkg-config-setups"></a> </p><h1>Example pkg config setups</h1>
<p>Each system may name the BLAS/LAPACK libraries differently, especially in the case of multiple packages and multiple ABI variants (int64, threads, OpenMP, etc. ). At a minimum MexIFace requires that proper <code>blas-int64.pc</code> and <code>lapack-int64.pc</code> configuration files exist on the <code>PKG_CONFIG_PATH</code>. </p><h2>Reference BLAS/LAPACK int64 pkg-config</h2>
<p>The simplest 64-bit Integer ABI setup uses the <a href="http://www.netlib.org/lapack/">reference BLAS/LAPACK</a>. The following example MexIFace-compatible pkg-config setup can be modified as required.</p>
<h3>Libraries</h3>
<ul>
<li><code>/usr/lib/librefblas_int64.so</code></li>
<li><code>/usr/lib/libreflapack_int64.so</code></li>
</ul>
<h3>pkg-config outputs</h3>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ pkg-config --libs --cflags --static lapack-int64</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;-lreflapack_int64 -lrefblas_int64</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;$ pkg-config --libs --cflags blas-int64</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;-lrefblas_int64</div></div><!-- fragment --><h3>pkg-config files</h3>
<h4><code>/usr/lib/pkgconfig/blas-int64.pc</code></h4>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;libdir=/usr/lib64</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;includedir=/usr/include</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;Name: BLAS-int64</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Version: 3.8.0</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Libs: -L${libdir} -lrefblas_int64</div></div><!-- fragment --><h4><code>/usr/lib/pkgconfig/lapack-int64.pc</code></h4>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;libdir=/usr/lib64</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;includedir=/usr/include</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;Name: LAPACK-int64</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Version: 3.8.0</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Libs: -L${libdir} -lreflapack_int64</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;Requires.private: blas-int64</div></div><!-- fragment --><h2>OpenBlas / Reference LAPACK int64 pkg-config</h2>
<p>For some BLAS and LAPACK workloads better performance can be achieved with the <a href="https://www.openblas.net/">OpenBLAS</a> package. A MexIFace-compatible reference setup is:</p>
<p>On an openblas/reference-lapack system the following output will be functional:</p>
<h3>Libraries</h3>
<ul>
<li><code>/usr/lib/libopenblas_int64.so</code></li>
<li><code>/usr/lib/libreflapack_int64.so</code></li>
</ul>
<h3>pkg-config outputs</h3>
<pre class="fragment">$ pkg-config --libs --cflags --static blas-int64
-DARCH_X86_64=1 -DOPENBLAS___64BIT__=1 -DOPENBLAS_USE64BITINT -I/usr/include/openblas -lopenblas_int64 -lm
$ pkg-config --libs --cflags --static lapack-int64
-DOPENBLAS___64BIT__=1 -DOPENBLAS_USE64BITINT -I/usr/include/openblas -lreflapack_int64 -lopenblas_int64 -lm
</pre><h3>pkg-config files</h3>
<h4><code>/usr/lib/pkgconfig/blas-int64.pc</code></h4>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;libdir=&quot;/usr/lib64&quot;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;includedir=&quot;/usr/include&quot;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;Name: openblas-int64</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Version: 0.2.20</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Libs: -L${libdir} -lopenblas_int64</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;Libs.private: -lm</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;Cflags: -I${includedir} -I${includedir}/openblas -DARCH_X86_64=1 -DOPENBLAS___64BIT__=1 -DOPENBLAS_USE64BITINT</div></div><!-- fragment --><h4><code>/usr/lib/pkgconfig/lapack-int64.pc</code></h4>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;libdir=/usr/lib64</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;includedir=/usr/include</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;Name: LAPACK-int64</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Version: 3.8.0</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Libs: -L${libdir} -lreflapack_int64</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;Requires.private: blas-int64</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
